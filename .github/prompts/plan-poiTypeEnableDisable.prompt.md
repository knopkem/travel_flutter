# Plan: POI Type Enable/Disable + Overpass API Optimization (Final)

Add checkboxes in settings to enable/disable individual POI types (all enabled by default, user opts out). Filter chips show only enabled types. Optimize Overpass and Wikidata queries to only fetch enabled types. Remove `landmark` and `square` types completely to simplify implementation.

## Steps

1. **Remove Landmark & Square Types** - In [poi_type.dart](lib/models/poi_type.dart): Remove `POIType.landmark` and `POIType.square` enum values. Update all switch statements and mappings in [poi.dart](lib/models/poi.dart) to remove these cases. In [overpass_repository.dart](lib/repositories/overpass_repository.dart) and [wikidata_repository.dart](lib/repositories/wikidata_repository.dart), remove any mappings that assign these types. **Default unmapped POIs to `POIType.other` instead of landmark.** Update `defaultPoiOrder` in [settings_service.dart](lib/utils/settings_service.dart) to remove landmark and square, leaving 8 types total.

2. **Extend Settings with Enabled Flag** - Modify [settings_service.dart](lib/utils/settings_service.dart): Change `defaultPoiOrder` from `List<POIType>` to a structure that includes both order and enabled state. Create `defaultPoiOrderWithState` as `List<(POIType, bool)>` with all 8 remaining types (monument, museum, religiousSite, park, viewpoint, touristAttraction, historicSite, other) set to enabled (`true`). Update `loadPoiOrder()` to return `List<(POIType, bool)>`, `savePoiOrder()` to accept it, and add `resetPoiOrder()`. In [settings_provider.dart](lib/providers/settings_provider.dart): Change `_poiTypeOrder` to `List<(POIType, bool)>`, add `enabledPoiTypes` getter returning only enabled types, `allPoiTypesDisabled` getter, `isPoiTypeEnabled(type)`, `updatePoiTypeEnabled(type, enabled)`, and `resetPoiTypes()` methods.

3. **Add POI Types Settings UI** - In [settings_screen.dart](lib/screens/settings_screen.dart): Create `_buildPoiTypesSection()` with ExpansionTile containing CheckboxListTile for each of 8 POI types. Show "X of 8 types enabled" count, warning banner if all disabled (similar to providers section at lines 66-81), and "Reset All" button to re-enable all. Insert between `_buildProvidersSection()` (which ends around line 174) and `_buildInterestsSection()`.

4. **Add Early Exit for All Types Disabled** - In [poi_provider.dart](lib/providers/poi_provider.dart) `discoverPOIs()` method: After the check for `allProvidersDisabled` at lines 81-89, add check for `_settingsProvider?.allPoiTypesDisabled == true`. If true, set empty `_pois` list, set `_error` to "Please enable at least one POI type in settings", update status to stopped/error state, and return early without API calls.

5. **Filter Chips & Post-Filter Results** - In [poi_list_widget.dart](lib/widgets/poi_list_widget.dart) `_buildFilterDropdown()` at line 294: Get `settingsProvider.enabledPoiTypes.toSet()`, filter `availableTypes` to only enabled types using `.where((type) => enabledTypes.contains(type))`. In [poi_provider.dart](lib/providers/poi_provider.dart) `_sortAndDeduplicate()` at line 239: After deduplication at line 245, **filter out disabled types** by adding `final enabledTypesSet = _settingsProvider?.enabledPoiTypes.toSet() ?? POIType.values.toSet();` and then `deduplicated = deduplicated.where((poi) => enabledTypesSet.contains(poi.type)).toList();`. This ensures POIs with disabled types are filtered out even if they appear from multiple sources.

6. **Optimize Overpass Query** - In [overpass_repository.dart](lib/repositories/overpass_repository.dart): Update `fetchNearbyPOIs()` signature to add optional `Set<POIType>? enabledTypes` parameter: `Future<List<POI>> fetchNearbyPOIs(Location city, {int radiusMeters = 10000, Set<POIType>? enabledTypes})`. Return empty list immediately if `enabledTypes` is empty. Update `_buildOverpassQuery()` at line 135 to accept `Set<POIType>? enabledTypes` parameter. Map enabled types to OSM tags (monument→`historic=monument|memorial`, museum→`tourism=museum|gallery`, viewpoint→`tourism=viewpoint`, park→`leisure=park`, religiousSite→`amenity=place_of_worship`, historicSite→`historic=castle|ruins|archaeological_site|fort`, touristAttraction→`tourism=attraction|artwork|zoo|aquarium|theme_park`, other→`tourism=* OR amenity=theatre|cinema|arts_centre`). Build conditional query sections only including tags for enabled types.

7. **Optimize Wikidata Query & Wire POIProvider** - In [wikidata_repository.dart](lib/repositories/wikidata_repository.dart): Update `fetchNearbyPOIs()` to add optional `Set<POIType>? enabledTypes` parameter: `Future<List<POI>> fetchNearbyPOIs(Location city, {int radiusMeters = 10000, Set<POIType>? enabledTypes})`. Return empty list immediately if `enabledTypes` is empty. Update `_buildSPARQLQuery()` at line 116 to accept `Set<POIType>? enabledTypes` parameter. Map enabled types to Q-codes (touristAttraction→Q570116, museum→Q33506, monument→Q4989906, historicSite→Q23413/Q839954, park→Q22698, religiousSite→Q16970, viewpoint→Q215380, other→query all types without restriction). Dynamically build `VALUES ?placeType {}` with only enabled Q-codes, or omit the VALUES filter entirely if `other` is enabled. In [poi_provider.dart](lib/providers/poi_provider.dart) `discoverPOIs()`: Get `enabledTypes = _settingsProvider?.enabledPoiTypes.toSet()`, pass to all three repository calls (Overpass, Wikidata, and Wikipedia). **Wikipedia POIs that default to `touristAttraction` will be filtered out in post-processing if that type is disabled.**

## Further Considerations

1. **Wikipedia Geosearch Handling** - Wikipedia API cannot filter by type at query level. All Wikipedia POIs default to `touristAttraction` type. They will be filtered out during post-processing in `_sortAndDeduplicate()` if that type is disabled. The API will still be called to maintain consistency and allow other sources to potentially upgrade the typing during deduplication.

2. **Settings Section Order** - "POI Types" section should appear before "Interests" (ranking) section, since enabling types is more fundamental than ranking them. Insert the new section between `_buildProvidersSection()` and `_buildInterestsSection()`.

3. **Migration for Existing Users** - Users with existing `poi_type_order` settings won't have enabled flags. The `loadPoiOrder()` method should detect old format (list of strings) and migrate by setting all types to enabled=true. New format stores as `"type=enabled"` pairs (e.g., `["monument=true", "museum=false"]`).

4. **Type Count Display** - UI should consistently show "X of 8 types enabled" since landmark and square are removed, leaving exactly 8 POI types total.

5. **Default for Unmapped POIs** - All POIs that don't match a specific type mapping (in Overpass, Wikidata, or Wikipedia) should default to `POIType.other`. This includes any edge cases or newly discovered place types.
